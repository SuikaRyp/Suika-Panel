<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Users - Productyl cPanel</title>
    
    <!-- Bootstrap 5 Dark -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-dark-5@1.1.3/dist/css/bootstrap-dark.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary: #4e54c8;
            --dark: #1a1a2e;
            --darker: #16213e;
        }
        
        body {
            background: linear-gradient(135deg, var(--dark) 0%, var(--darker) 100%);
            min-height: 100vh;
            color: #e0e0e0;
        }
        
        .sidebar {
            width: 250px;
            min-height: 100vh;
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            position: fixed;
            left: 0;
            top: 0;
            z-index: 1000;
        }
        
        .main-content {
            margin-left: 250px;
            padding: 20px;
        }
        
        .nav-link {
            color: #ccc;
            padding: 12px 20px;
            border-radius: 8px;
            margin: 5px 10px;
            transition: all 0.3s;
        }
        
        .nav-link:hover, .nav-link.active {
            background: var(--primary);
            color: white;
        }
        
        .user-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            transition: all 0.3s;
        }
        
        .user-card:hover {
            background: rgba(255, 255, 255, 0.08);
        }
        
        .status-active { color: #198754; }
        .status-suspended { color: #dc3545; }
        .status-pending { color: #ffc107; }
        
        @media (max-width: 768px) {
            .sidebar {
                width: 70px;
            }
            .sidebar .nav-text {
                display: none;
            }
            .main-content {
                margin-left: 70px;
            }
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="p-4 text-center border-bottom">
            <h4 class="text-warning mb-0">
                <i class="fas fa-crown me-2"></i>
                <span class="nav-text">Admin Panel</span>
            </h4>
            <small class="text-muted">Productyl cPanel</small>
        </div>
        
        <nav class="nav flex-column p-3">
            <a class="nav-link" href="index.html">
                <i class="fas fa-tachometer-alt me-2"></i>
                <span class="nav-text">Dashboard</span>
            </a>
            <a class="nav-link active" href="users.html">
                <i class="fas fa-users me-2"></i>
                <span class="nav-text">Manage Users</span>
            </a>
            <a class="nav-link" href="servers.html">
                <i class="fas fa-server me-2"></i>
                <span class="nav-text">All Servers</span>
            </a>
            <a class="nav-link" href="../create.html">
                <i class="fas fa-plus-circle me-2"></i>
                <span class="nav-text">Create Server</span>
            </a>
            
            <div class="mt-auto p-3">
                <div class="card bg-dark">
                    <div class="card-body p-3">
                        <div class="d-flex align-items-center">
                            <div class="me-3">
                                <i class="fas fa-user-shield fa-2x text-warning"></i>
                            </div>
                            <div>
                                <h6 class="mb-0" id="adminName">Admin</h6>
                                <small class="text-muted">Super Administrator</small>
                            </div>
                        </div>
                    </div>
                </div>
                <button class="btn btn-danger btn-sm w-100 mt-2" onclick="logout()">
                    <i class="fas fa-sign-out-alt me-1"></i>
                    <span class="nav-text">Logout</span>
                </button>
            </div>
        </nav>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 class="h3 mb-1">
                    <i class="fas fa-users me-2 text-primary"></i>Manage Users
                </h1>
                <small class="text-muted">Create, edit, and manage user accounts</small>
            </div>
            <button class="btn btn-primary" onclick="createNewUser()">
                <i class="fas fa-user-plus me-2"></i>Add New User
            </button>
        </div>

        <!-- Search and Filters -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="input-group">
                            <span class="input-group-text">
                                <i class="fas fa-search"></i>
                            </span>
                            <input type="text" class="form-control" id="searchUsers" 
                                   placeholder="Search users by name or email...">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="filterPackage">
                            <option value="">All Packages</option>
                            <option value="1">Basic 1GB</option>
                            <option value="2">Starter 2GB</option>
                            <option value="3">Standard 4GB</option>
                            <option value="4">Advanced 6GB</option>
                            <option value="5">Pro 8GB</option>
                            <option value="6">Enterprise 10GB</option>
                            <option value="7">UNLIMITED</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="filterStatus">
                            <option value="">All Status</option>
                            <option value="active">Active</option>
                            <option value="suspended">Suspended</option>
                            <option value="pending">Pending</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- Users Table -->
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>User</th>
                                <th>Email</th>
                                <th>Package</th>
                                <th>RAM Usage</th>
                                <th>Servers</th>
                                <th>Status</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="usersTable">
                            <!-- Will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
                
                <!-- Pagination -->
                <nav aria-label="Page navigation" class="mt-3">
                    <ul class="pagination justify-content-center" id="pagination">
                        <!-- Will be populated by JavaScript -->
                    </ul>
                </nav>
            </div>
        </div>
    </div>

    <!-- Create User Modal -->
    <div class="modal fade" id="createUserModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content bg-dark">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title">
                        <i class="fas fa-user-plus me-2"></i>Create New User
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="createUserForm">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Username *</label>
                                <input type="text" class="form-control" name="username" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Email Address *</label>
                                <input type="email" class="form-control" name="email" required>
                            </div>
                            
                            <div class="col-md-6">
                                <label class="form-label">Password *</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" name="password" id="userPassword" required>
                                    <button type="button" class="btn btn-outline-secondary" onclick="generatePassword()">
                                        <i class="fas fa-sync-alt"></i>
                                    </button>
                                </div>
                                <small class="text-muted">Save this password securely</small>
                            </div>
                            
                            <div class="col-md-6">
                                <label class="form-label">RAM Package *</label>
                                <select class="form-select" name="package_id" required>
                                    <option value="1">Basic 1GB - $5/month</option>
                                    <option value="2">Starter 2GB - $10/month</option>
                                    <option value="3" selected>Standard 4GB - $20/month</option>
                                    <option value="4">Advanced 6GB - $30/month</option>
                                    <option value="5">Pro 8GB - $40/month</option>
                                    <option value="6">Enterprise 10GB - $50/month</option>
                                    <option value="7">UNLIMITED - $100/month</option>
                                </select>
                            </div>
                            
                            <div class="col-md-6">
                                <label class="form-label">RAM Limit (MB)</label>
                                <input type="number" class="form-control" name="ram_limit" value="4096" min="1024">
                            </div>
                            
                            <div class="col-md-6">
                                <label class="form-label">Max Servers</label>
                                <input type="number" class="form-control" name="max_servers" value="3" min="1">
                            </div>
                            
                            <div class="col-12">
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i>
                                    The user will be able to login immediately with these credentials.
                                    Make sure to provide the password to the user securely.
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="submitCreateUser()">Create User</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div class="modal fade" id="editUserModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content bg-dark">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title">
                        <i class="fas fa-edit me-2"></i>Edit User
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editUserForm">
                        <input type="hidden" id="editUserId">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Username *</label>
                                <input type="text" class="form-control" id="editUsername" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Email Address *</label>
                                <input type="email" class="form-control" id="editEmail" required>
                            </div>
                            
                            <div class="col-md-6">
                                <label class="form-label">New Password</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="editPassword">
                                    <button type="button" class="btn btn-outline-secondary" onclick="generateEditPassword()">
                                        <i class="fas fa-sync-alt"></i>
                                    </button>
                                </div>
                                <small class="text-muted">Leave empty to keep current password</small>
                            </div>
                            
                            <div class="col-md-6">
                                <label class="form-label">RAM Package *</label>
                                <select class="form-select" id="editPackageId" required>
                                    <option value="1">Basic 1GB</option>
                                    <option value="2">Starter 2GB</option>
                                    <option value="3">Standard 4GB</option>
                                    <option value="4">Advanced 6GB</option>
                                    <option value="5">Pro 8GB</option>
                                    <option value="6">Enterprise 10GB</option>
                                    <option value="7">UNLIMITED</option>
                                </select>
                            </div>
                            
                            <div class="col-md-6">
                                <label class="form-label">RAM Limit (MB)</label>
                                <input type="number" class="form-control" id="editRamLimit" min="1024">
                            </div>
                            
                            <div class="col-md-6">
                                <label class="form-label">Max Servers</label>
                                <input type="number" class="form-control" id="editMaxServers" min="1">
                            </div>
                            
                            <div class="col-md-6">
                                <label class="form-label">Status</label>
                                <select class="form-select" id="editStatus">
                                    <option value="active">Active</option>
                                    <option value="suspended">Suspended</option>
                                    <option value="pending">Pending</option>
                                </select>
                            </div>
                            
                            <div class="col-md-6">
                                <label class="form-label">API Key</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="editApiKey" readonly>
                                    <button type="button" class="btn btn-outline-secondary" onclick="generateApiKey()">
                                        <i class="fas fa-sync-alt"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="submitEditUser()">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- App JS -->
    <script src="../assets/js/encryption.js"></script>
    <script src="../assets/js/auth.js"></script>
    <script src="../assets/js/admin.js"></script>
    
    <script>
        let currentPage = 1;
        const usersPerPage = 10;
        let filteredUsers = [];
        
        document.addEventListener('DOMContentLoaded', function() {
            // Check if admin is logged in
            const user = getCurrentUser();
            if (!user || !user.is_admin) {
                window.location.href = '../login.html';
                return;
            }
            
            // Update admin name
            document.getElementById('adminName').textContent = user.username;
            
            // Load users
            loadUsers();
            
            // Setup search and filter
            document.getElementById('searchUsers').addEventListener('input', filterUsers);
            document.getElementById('filterPackage').addEventListener('change', filterUsers);
            document.getElementById('filterStatus').addEventListener('change', filterUsers);
        });
        
        function loadUsers() {
            const users = getAllUsers();
            filteredUsers = [...users];
            renderUsersTable();
            renderPagination();
        }
        
        function filterUsers() {
            const searchTerm = document.getElementById('searchUsers').value.toLowerCase();
            const packageFilter = document.getElementById('filterPackage').value;
            const statusFilter = document.getElementById('filterStatus').value;
            
            const users = getAllUsers();
            
            filteredUsers = users.filter(user => {
                // Search filter
                const matchesSearch = !searchTerm || 
                    user.username.toLowerCase().includes(searchTerm) ||
                    user.email.toLowerCase().includes(searchTerm);
                
                // Package filter
                const matchesPackage = !packageFilter || user.package_id == packageFilter;
                
                // Status filter
                const matchesStatus = !statusFilter || (user.status || 'active') === statusFilter;
                
                return matchesSearch && matchesPackage && matchesStatus;
            });
            
            currentPage = 1;
            renderUsersTable();
            renderPagination();
        }
        
        function renderUsersTable() {
            const startIndex = (currentPage - 1) * usersPerPage;
            const endIndex = startIndex + usersPerPage;
            const pageUsers = filteredUsers.slice(startIndex, endIndex);
            
            const packages = getRamPackages();
            
            const tbody = document.getElementById('usersTable');
            tbody.innerHTML = pageUsers.map(user => {
                const packageInfo = packages[user.package_id] || packages[1];
                const servers = getUserServers(user.id);
                const ramPercentage = user.ram_limit > 0 ? 
                    Math.min(100, (user.ram_used / user.ram_limit) * 100) : 0;
                
                return `
                    <tr>
                        <td><strong>#${user.id}</strong></td>
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="bg-primary bg-opacity-25 rounded-circle p-2 me-3">
                                    <i class="fas fa-user"></i>
                                </div>
                                <div>
                                    <strong>${user.username}</strong>
                                    <small class="d-block text-muted">ID: ${user.id}</small>
                                </div>
                            </div>
                        </td>
                        <td>${user.email}</td>
                        <td>
                            <span class="badge bg-dark">${packageInfo.name}</span>
                        </td>
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="progress flex-grow-1 me-2" style="height: 6px;">
                                    <div class="progress-bar ${ramPercentage > 90 ? 'bg-danger' : 'bg-success'}" 
                                         style="width: ${ramPercentage}%"></div>
                                </div>
                                <small>${user.ram_used}MB / ${user.ram_limit === 0 ? 'âˆž' : user.ram_limit + 'MB'}</small>
                            </div>
                        </td>
                        <td>
                            <span class="badge bg-info">${servers.length} servers</span>
                        </td>
                        <td>
                            <span class="badge ${user.status === 'active' ? 'bg-success' : 
                                            user.status === 'suspended' ? 'bg-danger' : 'bg-warning'}">
                                ${user.status || 'active'}
                            </span>
                        </td>
                        <td>${new Date(user.created_at).toLocaleDateString()}</td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary" onclick="editUser(${user.id})" 
                                        title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-outline-success" onclick="viewUserServers(${user.id})" 
                                        title="View Servers">
                                    <i class="fas fa-server"></i>
                                </button>
                                <button class="btn btn-outline-warning" onclick="resetPassword(${user.id})" 
                                        title="Reset Password">
                                    <i class="fas fa-key"></i>
                                </button>
                                <button class="btn btn-outline-danger" onclick="deleteUserPrompt(${user.id})" 
                                        title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
            
            if (pageUsers.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" class="text-center py-4">
                            <i class="fas fa-users fa-3x mb-3 text-muted"></i>
                            <h5>No users found</h5>
                            <p class="text-muted">Try adjusting your search or filters</p>
                        </td>
                    </tr>
                `;
            }
        }
        
        function renderPagination() {
            const totalPages = Math.ceil(filteredUsers.length / usersPerPage);
            const pagination = document.getElementById('pagination');
            
            if (totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }
            
            let html = '';
            
            // Previous button
            html += `
                <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="changePage(${currentPage - 1})">
                        <i class="fas fa-chevron-left"></i>
                    </a>
                </li>
            `;
            
            // Page numbers
            const maxVisiblePages = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
            
            if (endPage - startPage + 1 < maxVisiblePages) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }
            
            for (let i = startPage; i <= endPage; i++) {
                html += `
                    <li class="page-item ${i === currentPage ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
                    </li>
                `;
            }
            
            // Next button
            html += `
                <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="changePage(${currentPage + 1})">
                        <i class="fas fa-chevron-right"></i>
                    </a>
                </li>
            `;
            
            pagination.innerHTML = html;
        }
        
        function changePage(page) {
            currentPage = page;
            renderUsersTable();
        }
        
        function logout() {
            localStorage.removeItem('currentUser');
            window.location.href = '../login.html';
        }
        
        function createNewUser() {
            generatePassword();
            const modal = new bootstrap.Modal(document.getElementById('createUserModal'));
            modal.show();
        }
        
        function generatePassword() {
            const password = PasswordEncryption.generateRandomPassword(12);
            document.getElementById('userPassword').value = password;
        }
        
        async function submitCreateUser() {
            const form = document.getElementById('createUserForm');
            const formData = new FormData(form);
            
            const userData = {
                username: formData.get('username'),
                email: formData.get('email'),
                password: formData.get('password'),
                package_id: formData.get('package_id'),
                ram_limit: formData.get('ram_limit'),
                max_servers: formData.get('max_servers')
            };
            
            const result = await createUser(userData);
            
            if (result.success) {
                alert(`User created successfully!\n\nUsername: ${userData.username}\nPassword: ${userData.password}\n\nSave these credentials!`);
                bootstrap.Modal.getInstance(document.getElementById('createUserModal')).hide();
                loadUsers();
            } else {
                alert('Error: ' + result.error);
            }
        }
        
        function editUser(userId) {
            const user = getUserById(userId);
            if (!user) return;
            
            document.getElementById('editUserId').value = user.id;
            document.getElementById('editUsername').value = user.username;
            document.getElementById('editEmail').value = user.email;
            document.getElementById('editPackageId').value = user.package_id;
            document.getElementById('editRamLimit').value = user.ram_limit;
            document.getElementById('editMaxServers').value = user.max_servers;
            document.getElementById('editStatus').value = user.status || 'active';
            document.getElementById('editApiKey').value = user.api_key || '';
            
            const modal = new bootstrap.Modal(document.getElementById('editUserModal'));
            modal.show();
        }
        
        function generateEditPassword() {
            const password = PasswordEncryption.generateRandomPassword(12);
            document.getElementById('editPassword').value = password;
        }
        
        function generateApiKey() {
            const apiKey = PasswordEncryption.generateApiKey();
            document.getElementById('editApiKey').value = apiKey;
        }
        
        async function submitEditUser() {
            const userId = document.getElementById('editUserId').value;
            const password = document.getElementById('editPassword').value;
            const apiKey = document.getElementById('editApiKey').value;
            
            const updateData = {
                username: document.getElementById('editUsername').value,
                email: document.getElementById('editEmail').value,
                package_id: document.getElementById('editPackageId').value,
                ram_limit: document.getElementById('editRamLimit').value,
                max_servers: document.getElementById('editMaxServers').value,
                status: document.getElementById('editStatus').value,
                api_key: apiKey
            };
            
            // Update password if provided
            if (password) {
                updateData.password_hash = await PasswordEncryption.hashPassword(password);
                alert(`Password updated! New password: ${password}\n\nSave this password!`);
            }
            
            const result = updateUser(userId, updateData);
            
            if (result.success) {
                alert('User updated successfully!');
                bootstrap.Modal.getInstance(document.getElementById('editUserModal')).hide();
                loadUsers();
            } else {
                alert('Error: ' + result.error);
            }
        }
        
        function viewUserServers(userId) {
            window.location.href = `servers.html?user=${userId}`;
        }
        
        async function resetPassword(userId) {
            const user = getUserById(userId);
            if (!user) return;
            
            const newPassword = PasswordEncryption.generateRandomPassword(12);
            const passwordHash = await PasswordEncryption.hashPassword(newPassword);
            
            const result = updateUser(userId, { password_hash: passwordHash });
            
            if (result.success) {
                alert(`Password reset for ${user.username}!\n\nNew password: ${newPassword}\n\nSave this password!`);
            } else {
                alert('Error resetting password!');
            }
        }
        
        function deleteUserPrompt(userId) {
            const user = getUserById(userId);
            if (!user) return;
            
            if (confirm(`Are you sure you want to delete user "${user.username}"?\n\nThis will also delete all their servers!`)) {
                const result = deleteUser(userId);
                if (result.success) {
                    alert('User deleted successfully!');
                    loadUsers();
                }
            }
        }
    </script>
</body>
</html>